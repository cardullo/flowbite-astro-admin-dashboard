---
import { useAuth } from 'auth-astro'
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = Deno.env.get('SUPABASE_URL')
const supabaseAnonKey = Deno.env.get('SUPABASE_ANON_KEY')
const supabase = createClient(supabaseUrl, supabaseAnonKey)

export default function AuthWrapper({ children }) {
  const auth = useAuth()

  if (auth.loading) {
    return <div>"Loading..."</div>
  }

  if (!auth.loggedIn) {
    window.location.href = '/login'
  }

  const { user } = auth

  const { data, error } = await supabase
    .from('users')
    .select('id')
    .eq('id', user.id)

  if (error) {
    console.error(error)
    return <div>Error</div>
  }

  if (!data || data.length === 0) {
    await supabase.from('users').insert({ id: user.id })
  }

  return children
}
---
